!function(t,i){"use strict";var e=t.MiniRefreshBiz||i(t);"undefined"!=typeof module&&module.exports?exports.MiniRefreshBiz=e:"function"==typeof define&&(define.amd||define.cmd)&&define(function(){return e}),t.MiniRefreshBiz=e}("undefined"!=typeof window?window:global,function(t){"use strict";function i(t){if("string"!=typeof t)return t;var i,e=document.createElement("div"),n=document.createDocumentFragment();for(e.innerHTML=t;i=e.firstChild;)n.appendChild(i);return n}function e(t){var i=this;t=a.extend(!0,{},f,t);var e=t.template;if("string"==typeof e&&/^[.#]/.test(e)||e instanceof HTMLElement){var n=a.selector(e);n&&(e=n.innerHTML.toString()||"")}t.template=e;var s=t.theme||r;if(!s)throw new Error("错误:请检查传入的minirefresh主题是否正确!");var o=t.setting;o.container=t.container,o.down&&(o.down.callback=function(){i._pullDownCallback()}),o.up&&(o.up.callback=function(){i._pullUpCallback()}),this.container=a.selector(t.container),this.listContainer=a.selector(t.listContainer),this.options=t,this.setting=o,this._initParams(),this.instance=new s(o),this._addEvent()}var n="log",s="warn",o="error",a=window.MiniRefreshTools,r=window.MiniRefresh,l=window.Mustache,u=window.mui,c=Util.ajax,h=Util.dataProcess,d="ontouchstart"in document,p=d?"tap":"click",f={isDebug:!1,container:"#minirefresh",listContainer:"#listdata",type:"POST",initPageIndex:0,url:null,template:"#item-template",dataRequest:null,dataChange:null,itemClick:null,success:null,error:null,pullDown:null,isAutoRender:!0,itemSelector:"li",isDenyAutoSend:!1,delay:0,timeout:6e3,accepts:{script:"text/javascript, application/javascript, application/x-javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},contentType:"application/x-www-form-urlencoded",headers:null,setting:{down:{},up:{isAuto:!0}}};return e.prototype={_log:function(t,i){this.options.isDebug&&console[t](i)},_initParams:function(){this.isNoMoreData=!1,this.currPage=this.options.initPageIndex,this.setting.up&&this.setting.up.isAuto&&this.currPage--},_pullDownCallback:function(){var t=this,i=this.options;this.loadingDown||(this.isPullDown=!0,this.loadingDown=!0,this.currPage=i.initPageIndex,setTimeout(function(){t._ajaxRequest()},i.delay),i.pullDown&&i.pullDown())},_pullUpCallback:function(){var t=this;this.loadingUp||(this.isPullDown=!1,this.loadingUp=!0,this.currPage++,setTimeout(function(){t._ajaxRequest()},this.options.delay))},_clearResponseEl:function(){this.options.isAutoRender&&this.listContainer&&(this.listContainer.innerHTML="")},_render:function(t){var e=this.options,n=0;if(e.isAutoRender)if(this.isPullDown&&this._clearResponseEl(),l)if(t&&Array.isArray(t)&&t.length>0){for(var s="",a=0,r=t.length;a<r;a++){var u=t[a],c="",h=e.template;h&&("string"==typeof h?c=h:"function"==typeof h&&(c=h(u))),s+=l.render(c,u),n++}""!==s&&this.listContainer.appendChild(i(s))}else this.isNoMoreData=!0;else this.isNoMoreData=!0,this._log(o,"error***没有包含mustache文件,无法进行模板渲染");return n},_dataChangeDefault:function(t){var i=h(t,{dataPath:["custom.infoList","custom.infolist","UserArea.InfoList"]});return i.data},_ajaxRequest:function(){var t=this,i=this.options;if(!i.url)return this._log(o,"error***url无效,无法访问"),void this._errorRequest(null,null,"请求url为空!");var e=function(e){var n="";n="function"==typeof i.url?i.url():i.url,c({isDenyAutoSend:i.isDenyAutoSend,url:n,data:e,dataType:"json",timeout:i.timeout,type:i.type,accepts:i.accepts,headers:i.headers,contentType:i.contentType,success:function(i){t._successRequest(i)},error:function(i,e){t._errorRequest(i,e,"请求失败!")}})};if(i.dataRequest){var n=i.dataRequest(this.currPage,function(t){e(t)});void 0!==n&&e(n)}else this._log(s,"warning***请注意dataRequest不存在,默认数据为空"),e()},_errorRequest:function(t,i,e){var n=this.options;this.isNoMoreData=!0,this._refreshState(!1),this.currPage--,this.currPage=this.currPage>=n.initPageIndex?this.currPage:n.initPageIndex,n.error&&n.error(t,i,e)},_successRequest:function(t){var i=this.options;if(!t)return this._log(s,"warning***返回的数据为空,请注意！"),this.isNoMoreData=!0,void this._refreshState(!1);this._log(n,"下拉刷新返回数据:"+JSON.stringify(t)),t=i.dataChange?i.dataChange(t):this._dataChangeDefault(t);var e=this._render(t);this.loadingMoreSuccess&&(this.loadingMoreSuccess(),this.loadingMoreSuccess=null),i.success&&"function"==typeof i.success&&i.success(t,this.isPullDown||this.currPage===i.initPageIndex),this._refreshState(!0,e)},_refreshState:function(t,i){i=i||0,this.isPullDown&&(this.instance.endDownLoading(t,"更新"+i+"条数据"),this.isNoMoreData&&(this.instance.resetUpLoading(),this.isNoMoreData=!1)),this.instance.endUpLoading(this.isNoMoreData),this.loadingDown=!1,this.loadingUp=!1},_addEvent:function(){var t=this.listContainer,i=this.options,e=i.itemClick;"function"==typeof e&&u(t).on(p,i.itemSelector,e)},refresh:function(){var t=this.options;!t.up||this.instance.options.up.isLock?(this._clearResponseEl(),this._pullDownCallback()):this.loadingUp||(this._clearResponseEl(),this.currPage=t.initPageIndex-1,this.loadingMore())},loadingMore:function(t){this.loadingMoreSuccess=t,this.isNoMoreData&&(this.instance.resetUpLoading(),this.isNoMoreData=!1),this.instance.triggerUpLoading()},refreshSetting:function(t){this.setting=a.extend(!0,{},this.setting,t),this.instance.refreshOptions(this.setting)},destroy:function(){u(this.listContainer).off(),this.container=null,this.listContainer=null,this.instance=null,this.options=null}},e});